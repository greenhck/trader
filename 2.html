<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Trading UI (Resilient Config)</title>
    <!-- Load Tailwind CSS -->
    <link rel="stylesheet" href="tailwind.min.css">
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <!-- Load API Config for yfinance -->
    <script src="api_config.js"></script>
    <style>
        /* Custom styles to ensure edge-to-edge fit and smooth transitions */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            overscroll-behavior: contain;
        }
        #app-container {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        /* Watchlist Header Animation (Hidden when scrolling down) */
        #watchlist-header {
            transition: transform 0.3s ease-in-out;
            will-change: transform;
            z-index: 20;
            position: sticky;
            top: 0;
        }

        /* --- Search Fullscreen Window (FADE-IN EFFECT) --- */
        #search-screen {
            position: fixed;
            inset: 0;
            background-color: white;
            z-index: 70;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
            max-width: 500px;
            margin: 0 auto;
            overflow-y: auto;
        }
        .search-open {
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* --- GTT Fullscreen Order Window (SIDE-SLIDE EFFECT) --- */
        .fullscreen-slide {
            position: fixed;
            inset: 0;
            background-color: white;
            z-index: 70;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            max-width: 500px;
            margin: 0 auto;
            overflow-y: auto;
        }
        .slide-open-side { /* Used only for GTT screen */
            transform: translateX(0%);
        }
        /* Bottom Sheet (Stock Details Popup) Animation */
        #stock-detail-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 60;
        }
        .sheet-open {
            transform: translateY(0%);
        }
        /* Index Popup Animation */
        #index-popup {
            transform: translateY(-100%);
            transition: transform 0.3s ease-out;
            z-index: 40;
        }
        .index-open {
            transform: translateY(0%);
        }
        /* Global Modal Overlay */
        #modal-overlay, #remove-stock-popup, #notes-popup, #alert-popup {
            z-index: 30; /* Adjusted z-index for overlay */
            transition: opacity 0.3s ease;
        }
        /* Ensure specific popups are above the sheet, but below fullscreen modals */
        #notes-popup, #alert-popup, #remove-stock-popup {
            z-index: 80;
        }
        /* Custom scrollbar for horizontal tabs */
        #watchlist-tabs::-webkit-scrollbar {
            display: none;
        }
        #watchlist-tabs {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Custom swipe animation container */
        #stock-list-container {
            overflow-x: scroll;
            scroll-behavior: smooth; /* Crucial for smooth tab switching */
            width: 100%;
        }
        .watchlist-page {
            flex-shrink: 0;
            width: 100%;
            padding-bottom: 80px; /* Space for the bottom nav */
        }
        /* Ensure Auth screen has highest Z-index for fullscreen takeover */
        #auth-screen {
             z-index: 90;
        }
    </style>
</head>
<body class="selection:bg-gray-200">

<!-- The main mobile container -->
<div id="app-container" class="h-screen overflow-hidden">

    <!-- Authentication Screen (Highest Priority) -->
    <div id="auth-screen" class="fixed inset-0 bg-white z-90 flex flex-col justify-center items-center p-8 transition-opacity duration-300">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">Trade Mobile</h1>
        <p id="auth-status" class="text-red-500 mb-4 text-sm"></p>

        <input id="auth-email" type="email" placeholder="Email" class="w-full mb-3 p-3 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <input id="auth-password" type="password" placeholder="Password" class="w-full mb-6 p-3 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500 focus:border-blue-500">

        <button id="auth-primary-btn" onclick="handleAuthAction('login')" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg text-lg active:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="toggleAuthMode()" class="mt-4 text-sm text-blue-600 hover:text-blue-700">
            Switch to Create Account
        </button>
    </div>

    <!-- Overlay for Popups/Bottom Sheet -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity"></div>

    <!-- Watchlist Index Popup (Half-screen) -->
    <div id="index-popup" class="fixed top-0 left-0 w-full h-1/2 bg-white shadow-xl max-w-[500px] mx-auto overflow-hidden">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-black">Market Indices</h2>
            <i onclick="toggleIndexPopup()" class="fa-solid fa-xmark text-lg text-black cursor-pointer p-2"></i>
        </div>
        <div id="index-list" class="p-4 space-y-3 overflow-y-auto h-full pb-16">
            <!-- Index items will be rendered here -->
        </div>
    </div>

    <!-- Search Fullscreen Window (Fade-in) -->
    <div id="search-screen" class="fixed inset-0 bg-white z-70 opacity-0 pointer-events-none transition-opacity duration-300 max-w-[500px] mx-auto overflow-y-auto">
        <!-- Search content will be rendered here when opened -->
    </div>

    <!-- GTT Fullscreen Order Window (Slide-in) -->
    <div id="gtt-screen" class="fullscreen-slide">
        <!-- GTT content will be rendered here when opened -->
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="flex-grow overflow-y-auto relative p-0">
        <!-- Watchlist Header (Sticky and Animating) -->
        <div id="watchlist-header" class="bg-white pt-4 px-4 pb-0 border-b border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <h1 class="text-xl font-bold text-black">Watchlist</h1>
                    <i id="index-toggle-icon" onclick="toggleIndexPopup()" class="fa-solid fa-chevron-down text-sm text-gray-500 cursor-pointer transition-transform duration-300"></i>
                </div>
                <div class="flex items-center space-x-4">
                    <i id="notification-icon" class="fa-solid fa-bell text-lg text-gray-700 cursor-pointer relative" onclick="openNotificationPopup()">
                        <span id="alert-dot" class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500 hidden"></span>
                    </i>
                    <i onclick="openSearch()" class="fa-solid fa-magnifying-glass text-lg text-gray-700 cursor-pointer"></i>
                </div>
            </div>
            <!-- Notification Popup (Arrow indicator) -->
            <div id="notification-popup" class="absolute right-4 top-14 mt-2 w-64 bg-white border border-gray-200 rounded-lg shadow-xl p-3 transform scale-0 origin-top-right transition-transform duration-200">
                <div class="absolute -top-2 right-3 w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-b-8 border-b-white shadow-md"></div>
                <p id="alert-message" class="text-sm text-black">No active alerts.</p>
            </div>

            <!-- Watchlist Tabs (Horizontal Scroll) -->
            <div id="watchlist-tabs" class="flex overflow-x-scroll whitespace-nowrap space-x-6 pb-2">
                <!-- Tabs will be rendered here -->
            </div>
        </div>

        <!-- Main Stock List Container (Swipable) -->
        <div id="stock-list-container" class="flex w-full" style="scroll-snap-type: x mandatory;">
            <!-- Watchlist pages will be rendered here -->
        </div>

    </div>

    <!-- Stock Detail Bottom Sheet Popup -->
    <div id="stock-detail-sheet" class="fixed bottom-0 left-0 w-full bg-white rounded-t-2xl shadow-2xl max-w-[500px] mx-auto overflow-hidden h-1/2 flex flex-col"
         ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
        <div class="p-4 flex flex-col">
            <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-3 cursor-grab"></div>

                        <!-- Header Info -->
            <div id="sheet-header-info" class="flex justify-between items-start mb-4">
                <!-- Content will be injected here -->
            </div>

                        <div class="w-full h-px bg-gray-200 mb-4"></div>

                        <!-- Action Buttons: Buy/Sell -->
            <div class="flex space-x-3 mb-4">
                <button id="btn-buy" class="flex-1 py-3 text-white font-semibold rounded-lg text-sm transition-all duration-150 bg-green-600 active:bg-green-700" onclick="updateHoldingQuantity(currentStock.id, 1)">
                    BUY
                </button>
                <button id="btn-sell" class="flex-1 py-3 text-white font-semibold rounded-lg text-sm transition-all duration-150 bg-red-600 active:bg-red-700" onclick="updateHoldingQuantity(currentStock.id, -1)">
                    SELL
                </button>
            </div>

                        <!-- Secondary Buttons -->
            <div class="grid grid-cols-3 gap-3 text-center mb-4 text-sm text-gray-700 font-medium">
                <button onclick="openAddNotePopup()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-pencil text-xs mr-1"></i> Add Note
                </button>
                <button onclick="openGTTOrder()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-cart-shopping text-xs mr-1"></i> Create GTT
                </button>
                <button onclick="openSetAlertPopup()" class="p-2 bg-gray-100 rounded-lg transition-colors active:bg-gray-200">
                    <i class="fa-solid fa-bell text-xs mr-1"></i> Set Alert
                </button>
            </div>

                        <div class="w-full h-px bg-gray-200 mb-4"></div>

                        <!-- Notes Section -->
            <div id="notes-list" class="overflow-y-auto space-y-2 h-20">
                <h3 class="text-sm font-semibold text-black mb-1">Notes:</h3>
                <!-- Notes will be injected here -->
                <p id="no-notes" class="text-xs text-gray-500 italic">No notes added for this stock.</p>
            </div>
        </div>
    </div>

    <!-- Universal Popup Containers (Modals for Notes and Alerts) -->
    <div id="notes-popup" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity z-80 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm transform scale-90 transition-transform duration-200">
            <h2 class="text-lg font-semibold text-black mb-4">Add Note for <span id="note-stock-name" class="text-blue-600"></span></h2>
            <textarea id="note-content" rows="4" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" placeholder="Type your note here..."></textarea>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeAddNotePopup()" class="px-4 py-2 text-sm text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
                <button onclick="saveNote()" class="px-4 py-2 text-sm text-white rounded-lg bg-blue-600 active:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="alert-popup" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity z-80 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm transform scale-90 transition-transform duration-200">
            <h2 class="text-lg font-semibold text-black mb-4">Set Price Alert</h2>
            <p class="text-sm text-gray-700 mb-2">Current Price: <span id="alert-current-price" class="font-bold text-black"></span></p>
            <div class="mb-4">
                <label for="alert-price-input" class="block text-sm font-medium text-gray-700 mb-1">Trigger Price:</label>
                <input type="number" id="alert-price-input" class="w-full border border-gray-300 rounded-md p-2 text-sm text-black focus:ring-0 focus:border-gray-500" placeholder="Enter target price">
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeSetAlertPopup()" class="px-4 py-2 text-sm text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
                <button onclick="saveAlert()" class="px-4 py-2 text-sm text-white rounded-lg bg-blue-600 active:bg-blue-700">Set Alert</button>
            </div>
        </div>
    </div>

    <!-- NEW: Remove Stock Confirmation Popup (Modal for Long Press) -->
    <div id="remove-stock-popup" class="fixed inset-0 bg-black/50 opacity-0 pointer-events-none transition-opacity z-80 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm transform scale-90 transition-transform duration-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-black">Remove Stock</h2>
                <i onclick="closeRemoveStockPopup()" class="fa-solid fa-xmark text-lg text-gray-500 cursor-pointer p-1"></i>
            </div>
            <p class="text-sm text-gray-700 mb-6">Are you sure you want to remove <span id="remove-stock-name" class="font-bold text-blue-600"></span> from <span id="remove-watchlist-name" class="font-bold text-blue-600"></span>?</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeRemoveStockPopup()" class="px-4 py-2 text-sm text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
                <button id="confirm-remove-btn" class="px-4 py-2 text-sm text-white rounded-lg bg-red-600 active:bg-red-700">Remove</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar (Fixed) -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 w-full border-t border-gray-200 bg-white max-w-[500px] mx-auto z-50">
        <div class="flex justify-around py-3 text-xs text-center">
            <div class="nav-item text-blue-600 flex flex-col items-center">
                <i class="fa-solid fa-list-ul text-xl mb-1"></i>
                <span class="text-xs">Watchlists</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-receipt text-xl mb-1"></i>
                <span class="text-xs">Orders</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-briefcase text-xl mb-1"></i>
                <span class="text-xs">Portfolio</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-xs">Notes</span>
            </div>
            <div class="nav-item text-gray-500 flex flex-col items-center">
                <i class="fa-solid fa-user-circle text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </div>
        </div>
    </nav>
</div>

<!-- Firebase and App Script -->
<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
        createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence,
        browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where,
        addDoc, getDocs, deleteDoc, updateDoc, writeBatch, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL STATE ---
    let app, db, auth;
    let userId = null;
    
    // API Configuration - Change this to your deployed API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbwsqHw7wkDm_Fk365xxSOZOt8AaMm6aX_ewGzVl_Ee3YlgP0_KLNMjE6fNFAafkvsq-/exec';  // Update with your deployed API URL
    
    // Cache for stock data fetched from API
    let stockDataCache = {};

    // Firestore-synced data
    let allWatchlists = [];
    let stockAlerts = {};
    let stockNotes = {};
    let portfolioHoldings = {};
    let initialListeners = []; // To store snapshot cleanup functions

    let currentWatchlistId = 'default';
    let currentWatchlistIndex = 0;
    let currentStock = null;
    let isAuthReady = false;
    let authMode = 'login'; // 'login' or 'signup'

    // Flags for history management (Fix for Physical Back Button)
    let isSearchOpen = false;
    let isGttOpen = false;
    let longPressTimer = null; // For stock long-press detection

    // Mock Data for Indices Popup (Remains static)
    const MOCK_INDICES = [
        { name: 'SENSEX', price: 73000.50, change: 250.20, percent: 0.34 },
        { name: 'NIFTY BANK', price: 48000.10, change: -150.80, percent: -0.31 },
        { name: 'NIFTY 50', price: 22100.75, change: 85.00, percent: 0.38 },
        { name: 'NIFTY FIN', price: 21500.25, change: 40.50, percent: 0.19 },
    ];

    // Global Constants
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // 1. BASE FIREBASE CONFIG (The "FIREBASE" config provided by the user)
    // This serves as the fallback/default configuration.
    const BASE_FIREBASE_CONFIG = {
        apiKey: "AIzaSyBHOdwCAsfvwhFMJf1ISWjekQyW1iVJ99c",
        authDomain: "weview129.firebaseapp.com",
        databaseURL: "https://weview129-default-rtdb.firebaseio.com",
        projectId: "weview129",
        storageBucket: "weview129.firebasestorage.app",
        messagingSenderId: "36284489552",
        appId: "1:36284489552:web:cd19d04a6dbe46039d9655",
        measurementId: "G-0NCKG4CRG7"
    };

    // 2. Robustly parse the firebase config from environment variable
    let configFromEnv = {};
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        try {
            configFromEnv = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Error parsing __firebase_config. It might be empty or invalid JSON:", e);
        }
    }

    // 3. Define the final FIREBASE_CONFIG, prioritizing environment config,
    // falling back to the hardcoded BASE_FIREBASE_CONFIG.
    const FIREBASE_CONFIG = {
        ...BASE_FIREBASE_CONFIG, // Start with all fields from the user's config
        // Override with environment variables if they exist
        apiKey: configFromEnv.apiKey || BASE_FIREBASE_CONFIG.apiKey,
        authDomain: configFromEnv.authDomain || BASE_FIREBASE_CONFIG.authDomain,
        projectId: configFromEnv.projectId || BASE_FIREBASE_CONFIG.projectId,
        storageBucket: configFromEnv.storageBucket || BASE_FIREBASE_CONFIG.storageBucket,
        messagingSenderId: configFromEnv.messagingSenderId || BASE_FIREBASE_CONFIG.messagingSenderId,
        appId: configFromEnv.appId || BASE_FIREBASE_CONFIG.appId
    };

    // --- UTILITY FUNCTIONS ---
    // Function to safely parse/clean up the new data format
    const formatStockData = (rawStock) => {
        // Safely check if Name exists and is a string before calling toLowerCase().
        const stockName = rawStock.Name && typeof rawStock.Name === 'string' ? rawStock.Name : 'Unknown Stock';

        // Function to safely parse a value, defaulting to 0
        const parseValue = (val) => {
             // Ensure val is not null/undefined, convert to string, remove commas and percent, then parse
            const cleanedVal = String(val || '0').replace(/,/g, '').replace('%', '').trim();
            return parseFloat(cleanedVal) || 0;
        }

        const ltp = parseValue(rawStock.LTP);
        const changePercent = parseValue(rawStock['Change(%)']);
        const change = (ltp * (changePercent / 100)) || 0; // Estimate change value

        return {
            // Use the safe stockName here
            id: stockName.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, ''),
            name: stockName,
            index: 'NSE', // Assuming default index
            price: ltp,
            change: change,
            percent: changePercent,
            raw: rawStock
        };
    };

    // --- FIREBASE DATA MANAGEMENT ---

    /**
     * Creates a standard path for user-specific collections.
     * Path: /artifacts/{appId}/users/{userId}/{collectionName}
     */
    const getCollectionPath = (collectionName) => {
        return `artifacts/${APP_ID}/users/${userId}/${collectionName}`;
    };

    /**
     * Sets up real-time listeners for all user data.
     */
    const setupRealtimeListeners = () => {
        if (!db || !userId) return;

        // Clear old listeners if they exist
        initialListeners.forEach(unsubscribe => unsubscribe());
        initialListeners = [];

        // 1. Watchlists Listener
        const watchlistsQuery = collection(db, getCollectionPath('watchlists'));
        initialListeners.push(onSnapshot(watchlistsQuery, (snapshot) => {
            allWatchlists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Ensure a default watchlist exists if empty
            if (allWatchlists.length === 0) {
                initializeDefaultWatchlist();
            } else {
                allWatchlists.sort((a, b) => (a.order || 0) - (b.order || 0));
                currentWatchlistId = allWatchlists[currentWatchlistIndex]?.id || allWatchlists[0].id;
                renderWatchlistTabs();
                renderStockList();
            }
        }, (error) => {
            console.error("Watchlists Snapshot Error:", error);
        }));

        // 2. Holdings Listener
        const holdingsQuery = doc(db, getCollectionPath('holdings'), 'my_holdings');
        initialListeners.push(onSnapshot(holdingsQuery, (docSnapshot) => {
            portfolioHoldings = docSnapshot.exists() ? docSnapshot.data().stocks || {} : {};
            renderStockList(); // Re-render to show updated holdings count
        }, (error) => {
            console.error("Holdings Snapshot Error:", error);
        }));

        // 3. Alerts Listener
        const alertsQuery = doc(db, getCollectionPath('alerts'), 'my_alerts');
        initialListeners.push(onSnapshot(alertsQuery, (docSnapshot) => {
            stockAlerts = docSnapshot.exists() ? docSnapshot.data().alerts || {} : {};
            checkActiveAlerts();
        }, (error) => {
            console.error("Alerts Snapshot Error:", error);
        }));

        // 4. Notes Listener
        const notesQuery = doc(db, getCollectionPath('notes'), 'my_notes');
        initialListeners.push(onSnapshot(notesQuery, (docSnapshot) => {
            stockNotes = docSnapshot.exists() ? docSnapshot.data().notes || {} : {};
        }, (error) => {
            console.error("Notes Snapshot Error:", error);
        }));

        // 5. Stocks Listener - Load stocks data from Firebase
        const stocksQuery = collection(db, getCollectionPath('stocks'));
        initialListeners.push(onSnapshot(stocksQuery, (snapshot) => {
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                stockDataCache[doc.id] = {
                    symbol: data.symbol,
                    name: data.name,
                    ltp: data.ltp,
                    change: data.change,
                    percent: data.percent,
                    index: data.exchange
                };
            });
            renderStockList();
        }, (error) => {
            console.error("Stocks Snapshot Error:", error);
        }));

        console.log("Firestore Listeners started for user:", userId);
    };

    /**
     * Initializes a default watchlist if none exists.
     */
    const initializeDefaultWatchlist = async () => {
        if (!db || !userId) return;

        const defaultId = 'my-watchlist';
        // Start with empty watchlist - user can search and add stocks
        const initialStocks = [];

        try {
            await setDoc(doc(db, getCollectionPath('watchlists'), defaultId), {
                name: 'My Watchlist',
                stocks: initialStocks,
                order: 0
            });
            console.log("Default watchlist created in Firestore.");
        } catch (e) {
            console.error("Error adding default document: ", e);
        }
    };

    // --- AUTHENTICATION FUNCTIONS ---
    window.handleAuthAction = async (action) => {
        const emailEl = document.getElementById('auth-email');
        const passwordEl = document.getElementById('auth-password');
        const statusEl = document.getElementById('auth-status');
        const email = emailEl.value;
        const password = passwordEl.value;

        if (!email || !password) {
            statusEl.textContent = 'Please enter both email and password.';
            return;
        }

        statusEl.textContent = 'Processing...';

        try {
            if (action === 'login') {
                await signInWithEmailAndPassword(auth, email, password);
            } else { // signup
                await createUserWithEmailAndPassword(auth, email, password);
            }
            // onAuthStateChanged handles success
        } catch (error) {
            let message = 'An unknown error occurred.';
            if (error.code.includes('auth/')) {
                 message = error.message.replace('Firebase: ', '');
            }
            statusEl.textContent = `Error: ${message}`;
        }
    };

    window.toggleAuthMode = () => {
        authMode = authMode === 'login' ? 'signup' : 'login';
        const primaryBtn = document.getElementById('auth-primary-btn');
        const toggleBtn = document.querySelector('#auth-screen button:last-child');

        if (authMode === 'login') {
            primaryBtn.textContent = 'Login';
            primaryBtn.onclick = () => handleAuthAction('login');
            toggleBtn.textContent = 'Switch to Create Account';
        } else {
            primaryBtn.textContent = 'Create Account';
            primaryBtn.onclick = () => handleAuthAction('signup');
            toggleBtn.textContent = 'Switch to Login';
        }
        document.getElementById('auth-status').textContent = '';
    };

    const hideAuthScreen = () => {
        // Hides the auth screen and allows interaction with the app
        const authScreen = document.getElementById('auth-screen');
        authScreen.style.opacity = '0';
        authScreen.style.pointerEvents = 'none';
        document.body.style.overflow = ''; // Restore body scrolling if necessary
    };

    const showAuthScreen = () => {
        // Shows the auth screen and prevents interaction with the app content
        const authScreen = document.getElementById('auth-screen');
        authScreen.style.opacity = '1';
        authScreen.style.pointerEvents = 'auto';
        document.body.style.overflow = 'hidden'; // Lock body scroll when auth is visible
    };

    // --- INITIALIZATION ---
    window.onload = async function() {
        setLogLevel('Debug');

        try {
            // CRITICAL FIX CHECK: Ensure API key is present from either source.
            if (!FIREBASE_CONFIG.apiKey) {
                 console.error("FATAL: Firebase config is missing API Key. Check BASE_FIREBASE_CONFIG and __firebase_config.");
                 document.getElementById('auth-status').textContent = "Initialization Failed: Missing Firebase API Key.";
                 return;
            }

            app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);

            // 2. Auth State Change Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User Authenticated:", userId);
                    hideAuthScreen(); // Hide auth screen on successful login
                    setupRealtimeListeners();
                    renderIndicesPopup();
                    setupWatchlistScrollBehavior();
                    isAuthReady = true;
                } else {
                    userId = null;
                    isAuthReady = false;

                    if (INITIAL_AUTH_TOKEN) {
                        try {
                            signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                        } catch (e) {
                            console.warn("Custom token sign-in failed. Falling back to email/password auth.", e);
                            showAuthScreen(); // Show auth screen if token fails
                        }
                    } else {
                        showAuthScreen(); // No token, show the regular auth screen
                    }
                }
            });

        } catch(e) {
            console.error("Firebase Initialization Error:", e);
            document.getElementById('auth-status').textContent = "Initialization Failed: " + e.message;
        }

        // 3. Setup History Listener for Navigation Fix (Physical Back Button)
        window.addEventListener('popstate', (e) => {
            const searchScreen = document.getElementById('search-screen');
            const gttScreen = document.getElementById('gtt-screen');

            // If a modal is open, close it without pushing another state
            if (searchScreen.classList.contains('search-open')) {
                closeSearch(false);
            } else if (gttScreen.classList.contains('slide-open-side')) {
                closeGTTOrder(false);
            }
            // If no modal is open, let the browser handle the navigation naturally
        });
    };

    // --- UI RENDERING FUNCTIONS ---

    // Helper to get formatted stock data from cache
    const getStockById = (id) => {
        // Get from cache (populated by Firebase listener)
        if (stockDataCache[id]) {
            return {
                ...stockDataCache[id],
                id: id,  // Add id property for compatibility
                price: stockDataCache[id].ltp  // Add price alias for ltp
            };
        }
        // Return placeholder while loading
        return {
            id: id,
            symbol: id,
            name: id,
            ltp: 0,
            price: 0,
            change: 0,
            percent: 0,
            index: 'Loading...'
        };
    };

    const renderWatchlistTabs = () => {
        const tabsEl = document.getElementById('watchlist-tabs');
        tabsEl.innerHTML = '';
        allWatchlists.forEach((list, index) => {
            const isActive = list.id === currentWatchlistId;
            const tab = document.createElement('div');
            tab.className = `cursor-pointer pb-2 text-sm font-medium transition-colors ${isActive ? 'text-black font-semibold' : 'text-gray-500'}`;
            tab.style.borderBottom = isActive ? '2px solid #3b82f6' : '2px solid transparent';
            tab.textContent = list.name;
            tab.dataset.id = list.id;

            // Fix: Simple click changes watchlist
            tab.onclick = () => changeWatchlist(list.id, index);

            // Removed oncontextmenu as per user request, long-press logic is now on stock items
            // tab.oncontextmenu = (e) => handleEditWatchlistName(e, list.id);

            tabsEl.appendChild(tab);
        });

        // Add the '+' icon
        const addTab = document.createElement('div');
        addTab.className = 'cursor-pointer pb-2 text-gray-500 hover:text-black transition-colors px-2';
        addTab.innerHTML = '<i class="fa-solid fa-plus text-lg"></i>';
        addTab.onclick = addNewWatchlist;
        tabsEl.appendChild(addTab);
    };

    const renderStockList = () => {
        const listContainer = document.getElementById('stock-list-container');
        if (allWatchlists.length === 0) {
            listContainer.innerHTML = `<p class="p-4 text-gray-500 text-sm italic w-full">Loading or no watchlists created.</p>`;
            return;
        }

        const containerWidth = listContainer.offsetWidth;
        listContainer.innerHTML = '';

        allWatchlists.forEach((list) => {
            const watchlistPage = document.createElement('div');
            watchlistPage.className = 'watchlist-page';
            watchlistPage.dataset.watchlistId = list.id;
            watchlistPage.style.width = `${containerWidth}px`; // Explicitly set width for snapping/scrolling
            watchlistPage.style.scrollSnapAlign = 'start'; // Ensure snap behavior

            const currentStockIds = list.stocks || [];
            const stocksToShow = currentStockIds
                .map(id => getStockById(id))
                .filter(stock => stock);

            if (stocksToShow.length === 0) {
                watchlistPage.innerHTML = `<p class="p-4 text-gray-500 text-sm italic">Add stocks using the search icon above.</p>`;
            } else {
                let html = stocksToShow.map(stock => {
                    // Use new data format: stock.price, stock.percent
                    const isPositive = stock.percent >= 0;
                    const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
                    const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';

                    const holdingQty = portfolioHoldings[stock.id] || 0;
                    const holdingText = holdingQty > 0 ? `<span class="text-xs text-gray-500 ml-1 font-semibold">(${holdingQty} Held)</span>` : '';

                    // Format LTP using toLocaleString for Indian number style (optional, but good for finance)
                    const ltpFormatted = stock.price.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    // Added ontouchstart/ontouchend for long-press detection
                    return `
                        <div class="px-4 py-3 flex justify-between items-center cursor-pointer active:bg-gray-50"
                             onclick="handleStockClickWrapper(event, '${stock.id}')"
                             ontouchstart="handlePressStart('${stock.id}')"
                             ontouchend="handlePressEnd(event, '${stock.id}')"
                             data-stock-id="${stock.id}">
                            <!-- Left Aligned Info -->
                            <div>
                                <p class="text-sm font-semibold text-black">${stock.name}</p>
                                <p class="text-xs text-gray-500 mt-0.5 uppercase">${stock.index} ${holdingText}</p>
                            </div>
                            <!-- Right Aligned Info -->
                            <div class="text-right">
                                <p class="text-sm font-semibold text-black">${ltpFormatted}</p>
                                <p class="text-xs ${changeColor} mt-0.5">
                                    <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                                </p>
                            </div>
                        </div>
                        <div class="h-px bg-gray-100 mx-4"></div>
                    `;
                }).join('');
                watchlistPage.innerHTML = html;
            }

            listContainer.appendChild(watchlistPage);
        });

        // Set the initial scroll position to the current watchlist
        listContainer.scrollLeft = currentWatchlistIndex * containerWidth;
    };

    const renderIndicesPopup = () => {
        const indexListEl = document.getElementById('index-list');
        indexListEl.innerHTML = MOCK_INDICES.map(index => {
            const isPositive = index.change >= 0;
            const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
            const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';

            return `
                <div class="flex justify-between items-center p-3 border border-gray-100 rounded-lg shadow-sm">
                    <p class="text-sm font-semibold text-black">${index.name}</p>
                    <div class="text-right">
                        <p class="text-sm font-semibold text-black">${index.price.toFixed(2)}</p>
                        <p class="text-xs ${changeColor} mt-0.5">
                            <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(index.change).toFixed(2)} (${Math.abs(index.percent).toFixed(2)}%)
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    };

    // --- INTERACTION HANDLERS ---

    // 1. Long Press/Tap Handlers (New)
    window.handlePressStart = (stockId) => {
        // Clear any existing timer just in case
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }

        // Start timer for long press
        longPressTimer = setTimeout(() => {
            // Long press detected
            openRemoveStockPopup(stockId);
            longPressTimer = null; // Mark as null after opening popup
        }, 700);
    };

    window.handlePressEnd = (e, stockId) => {
        // If longPressTimer is still set, it means it was a TAP (not a long press)
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            // Let the standard onclick event fire via handleStockClickWrapper
        }
        // If longPressTimer is null, the long press handler already fired the popup
    };

    window.handleStockClickWrapper = (e, stockId) => {
        // Only allow the click if the long press timer did not fire the remove popup.
        // We check the popup state: if it's open, the click should be ignored.
        if (!document.getElementById('remove-stock-popup').classList.contains('opacity-100')) {
            handleStockClick(stockId);
        }
    }

    // 2. Holding Management (Buy/Sell)
    window.updateHoldingQuantity = async (stockId, change) => {
        if (!userId) return;

        // Get current holding or default to 0
        let currentHolding = portfolioHoldings[stockId] || 0;
        let newHolding = currentHolding + change;

        if (newHolding < 0) {
            console.warn("Cannot sell more than held.");
            return;
        }

        try {
            await saveToSheets('updateHoldings', {
                stockId: stockId,
                quantity: newHolding
            });

            closeStockDetailSheet();
            // Polling will refresh the UI automatically
        } catch (error) {
            console.error("Error updating holdings:", error);
        }
    };

    // 3. Header Scroll Hide/Show
    let lastScrollTop = 0;
    const watchlistHeader = document.getElementById('watchlist-header');
    const mainContent = document.getElementById('main-content');

    const setupWatchlistScrollBehavior = () => {
        mainContent.addEventListener('scroll', () => {
            const scrollTop = mainContent.scrollTop;

            if (scrollTop > lastScrollTop && scrollTop > 50) {
                // Scrolling down - Hide the header
                watchlistHeader.style.transform = 'translateY(-100%)';
            } else if (scrollTop < lastScrollTop || scrollTop < 50) {
                // Scrolling up - Show the header
                watchlistHeader.style.transform = 'translateY(0)';
            }
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
        });
    }

    // 4. Index Popup (Down Arrow)
    window.toggleIndexPopup = () => {
        const popup = document.getElementById('index-popup');
        const overlay = document.getElementById('modal-overlay');
        const toggleIcon = document.getElementById('index-toggle-icon');

        const isOpen = popup.classList.toggle('index-open');

        if (isOpen) {
            overlay.classList.replace('opacity-0', 'opacity-100');
            overlay.classList.replace('pointer-events-none', 'pointer-events-auto');
            overlay.onclick = toggleIndexPopup;
            toggleIcon.classList.replace('fa-chevron-down', 'fa-xmark');
            toggleIcon.classList.add('text-black');
        } else {
            overlay.classList.replace('opacity-100', 'opacity-0');
            overlay.classList.replace('pointer-events-auto', 'pointer-events-none');
            overlay.onclick = null;
            toggleIcon.classList.replace('fa-xmark', 'fa-chevron-down');
            toggleIcon.classList.remove('text-black');
        }
    };

    // 5. Watchlist Management
    window.changeWatchlist = (id, index) => {
        currentWatchlistId = id;
        currentWatchlistIndex = index;
        renderWatchlistTabs();
        // Smooth scroll the list container (Fix for visual swipe effect)
        document.getElementById('stock-list-container').scrollLeft = index * document.getElementById('stock-list-container').offsetWidth;
    };

    window.handleEditWatchlistName = async (e, id) => {
        e.preventDefault(); // Prevent context menu on long press
        if (!userId) return;

        const list = allWatchlists.find(w => w.id === id);
        if (!list) return;

        // Use a simple prompt for now, or you could implement a custom modal
        const newName = prompt(`Enter new name for: ${list.name}`);
        if (newName && newName.trim() && newName.trim() !== list.name) {
            await saveToSheets('saveWatchlist', {
                watchlistId: id,
                name: newName.trim(),
                stocks: list.stocks,
                order: list.order
            });
        }
    };

    window.addNewWatchlist = async () => {
        if (!userId) return;

        const name = prompt("Enter new watchlist name:");
        if (name && name.trim()) {
            try {
                await saveToSheets('saveWatchlist', {
                    watchlistId: generateId(),
                    name: name.trim(),
                    stocks: [],
                    order: allWatchlists.length
                });
            } catch (e) {
                console.error("Error adding new watchlist:", e);
            }
        }
    };
    
    // Helper function to generate IDs
    function generateId() {
        return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // 6. Search Functionality (Now a Fullscreen Fade Modal - Fixed as requested)
    window.openSearch = () => {
        const searchScreen = document.getElementById('search-screen');
        searchScreen.innerHTML = `
            <div class="p-4 border-b border-gray-100 flex items-center bg-white sticky top-0">
                <!-- Back button now triggers history.back() which is intercepted by popstate -->
                <i class="fa-solid fa-arrow-left text-lg text-black cursor-pointer mr-3" onclick="closeSearch()"></i>
                <input id="search-input" type="text" placeholder="Search stocks, F&O, indices"
                       class="w-full bg-gray-100 text-black placeholder-gray-500 rounded-lg py-2 pl-4 pr-4 text-sm focus:outline-none focus:ring-0 focus:bg-white focus:shadow-md transition-all duration-300"
                       oninput="handleSearchInput(this.value)" autofocus>
            </div>
            <div id="search-results" class="p-4 space-y-2">
                <p class="text-sm text-gray-500 p-2">Start typing to search...</p>
            </div>
        `;
        document.body.style.overflow = 'hidden';
        isSearchOpen = true; // Set flag
        history.pushState({ screen: 'search' }, 'Search', '#search'); // Push state for back button

        // FADE-IN: Full white page
        searchScreen.classList.add('search-open');
    };

    // useHistory = false when called from popstate handler (physical back button)
    window.closeSearch = (useHistory = true) => {
        const searchScreen = document.getElementById('search-screen');

        // FADE-OUT
        searchScreen.classList.remove('search-open');
        document.body.style.overflow = '';
        isSearchOpen = false; // Clear flag

        // Only manipulate history if closing via the button (not via the popstate)
        if (useHistory) {
            history.back(); // This triggers the popstate, which we already handle
        }
    };

    window.handleSearchInput = async (value) => {
        const resultsEl = document.getElementById('search-results');
        if (value.length < 2) {
            resultsEl.innerHTML = '<p class="text-sm text-gray-500 p-2">Start typing to search...</p>';
            return;
        }

        // Show loading state
        resultsEl.innerHTML = '<p class="text-sm text-gray-500 p-2">Searching...</p>';

        try {
            // Search using yfinance API
            const results = await searchStocksAPI(value);

            if (results.length === 0) {
                resultsEl.innerHTML = '<p class="text-sm text-gray-500 p-2">No stocks found</p>';
                return;
            }

            const currentList = allWatchlists.find(w => w.id === currentWatchlistId);

            resultsEl.innerHTML = results.map(stock => {
                const stockId = stock.symbol;
                const isAdded = currentList?.stocks?.includes(stockId);
                const actionIcon = isAdded ? 'fa-check text-green-600' : 'fa-plus text-blue-600';
                const actionText = isAdded ? 'Added' : 'Add';

                return `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-black">${stock.name}</p>
                            <p class="text-xs text-gray-500 uppercase">${stock.exchange} • ${stock.symbol}</p>
                        </div>
                        <button class="flex items-center space-x-1 p-1" onclick="addStockToWatchlist(event, '${stockId}', '${stock.name}', '${stock.exchange}')">
                            <i class="fa-solid ${actionIcon} text-xs"></i>
                            <span class="text-xs text-gray-600">${actionText}</span>
                        </button>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Search error:', error);
            resultsEl.innerHTML = '<p class="text-sm text-red-500 p-2">Search failed. Check your internet connection.</p>';
        }
    };

    window.addStockToWatchlist = async (event, symbol, name, exchange) => {
        event.stopPropagation();
        if (!userId) return;

        const currentList = allWatchlists.find(w => w.id === currentWatchlistId);
        if (!currentList) return;

        // Check if already added
        if (currentList.stocks.includes(symbol)) {
            // Remove stock
            const newStocks = currentList.stocks.filter(s => s !== symbol);
            try {
                const listRef = doc(db, getCollectionPath('watchlists'), currentList.id);
                await updateDoc(listRef, { stocks: newStocks });
                
                // Also remove from Firebase stocks collection
                await deleteDoc(doc(db, getCollectionPath('stocks'), symbol));
                
                // Remove from cache
                delete stockDataCache[symbol];
                
                // Update search UI
                handleSearchInput(document.getElementById('search-input').value);
            } catch (error) {
                console.error("Error removing stock:", error);
            }
            return;
        }

        // Fetch full stock data from API and add to Firebase
        try {
            const stockData = await fetchStockData(symbol);
            
            if (!stockData) {
                alert('Failed to fetch stock data. Check your internet connection or try a different symbol.');
                return;
            }

            // Add stock to watchlist
            const newStocks = [...currentList.stocks, symbol];
            const listRef = doc(db, getCollectionPath('watchlists'), currentList.id);
            await updateDoc(listRef, { stocks: newStocks });
            
            // Store stock data in Firebase
            await setDoc(doc(db, getCollectionPath('stocks'), symbol), {
                symbol: stockData.symbol,
                name: stockData.name,
                ltp: stockData.ltp,
                change: stockData.change,
                percent: stockData.percent,
                exchange: stockData.exchange,
                lastUpdated: new Date().toISOString()
            });
            
            // Update cache
            stockDataCache[symbol] = {
                symbol: stockData.symbol,
                name: stockData.name,
                ltp: stockData.ltp,
                change: stockData.change,
                percent: stockData.percent,
                index: stockData.exchange
            };
            
            // Update search UI
            handleSearchInput(document.getElementById('search-input').value);
        } catch (error) {
            console.error("Error adding stock to watchlist:", error);
            alert('Failed to add stock: ' + error.message);
        }
    };

    window.toggleStockInWatchlist = async (event, stockId) => {
        event.stopPropagation();
        if (!userId) return;

        const currentList = allWatchlists.find(w => w.id === currentWatchlistId);
        if (!currentList) return;

        const index = currentList.stocks.indexOf(stockId);
        const newStocks = [...currentList.stocks];

        if (index > -1) {
            newStocks.splice(index, 1); // Remove
        } else {
            newStocks.push(stockId); // Add
        }

        try {
            const listRef = doc(db, getCollectionPath('watchlists'), currentList.id);
            await updateDoc(listRef, { stocks: newStocks });
            // Listener will handle re-rendering, just update the search UI instantly
            handleSearchInput(document.getElementById('search-input').value);
        } catch (error) {
            console.error("Error toggling stock in watchlist:", error);
        }
    };

    // 7. Remove Stock Popup Handlers (New)
    window.openRemoveStockPopup = (stockId) => {
        const stock = getStockById(stockId);
        const watchlist = allWatchlists.find(w => w.id === currentWatchlistId);

        if (!stock || !watchlist) return;

        document.getElementById('remove-stock-name').textContent = stock.name;
        document.getElementById('remove-watchlist-name').textContent = watchlist.name;
        // Set the action handler on the confirm button
        document.getElementById('confirm-remove-btn').onclick = () => removeStockFromWatchlist(stockId, watchlist.id);

        const popup = document.getElementById('remove-stock-popup');
        popup.classList.add('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-90', 'scale-100');
    };

    window.closeRemoveStockPopup = () => {
        const popup = document.getElementById('remove-stock-popup');
        popup.classList.remove('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-100', 'scale-90');
    };

    window.removeStockFromWatchlist = async (stockId, watchlistId) => {
        closeRemoveStockPopup();
        if (!userId) return;

        const list = allWatchlists.find(w => w.id === watchlistId);
        if (!list) return;

        const newStocks = list.stocks.filter(id => id !== stockId);

        try {
            await saveToSheets('saveWatchlist', {
                watchlistId: watchlistId,
                name: list.name,
                stocks: newStocks,
                order: list.order
            });
            console.log(`Removed ${stockId} from ${watchlistId}`);
        } catch (error) {
            console.error("Error removing stock from watchlist:", error);
        }
    };

    // 8. Stock Detail Bottom Sheet
    let startY = 0;
    let currentSheetOffset = 0;

    window.handleTouchStart = (e) => {
        startY = e.touches[0].clientY;
        document.getElementById('stock-detail-sheet').style.transition = 'none';
    };

    window.handleTouchMove = (e) => {
        const diffY = e.touches[0].clientY - startY;
        if (diffY > 0) {
            currentSheetOffset = diffY;
            document.getElementById('stock-detail-sheet').style.transform = `translateY(${diffY}px)`;
        }
    };

    window.handleTouchEnd = () => {
        const sheet = document.getElementById('stock-detail-sheet');
        sheet.style.transition = 'transform 0.3s ease-out';
        const heightToClose = sheet.offsetHeight * 0.2;

        if (currentSheetOffset > heightToClose) {
            closeStockDetailSheet();
        } else {
            sheet.style.transform = 'translateY(0%)';
        }
        currentSheetOffset = 0;
    };

    window.handleStockClick = (stockId) => {
        const stock = getStockById(stockId);
        if (!stock) return;
        currentStock = stock;

        const holdingQty = portfolioHoldings[stockId] || 0;
        const sheet = document.getElementById('stock-detail-sheet');
        const overlay = document.getElementById('modal-overlay');

        // Use new data format: stock.price, stock.percent
        const isPositive = stock.percent >= 0;
        const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
        const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';
        const holdingText = holdingQty > 0 ? `<span class="font-medium text-black">(${holdingQty} held)</span>` : '';
        const ltpFormatted = stock.price.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        document.getElementById('sheet-header-info').innerHTML = `
            <div>
                <p class="text-lg font-bold text-black">${stock.name}</p>
                <p class="text-xs text-gray-500 uppercase mt-0.5">${stock.index} ${holdingText}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-bold text-black">${ltpFormatted}</p>
                <p class="text-xs ${changeColor} mt-0.5">
                    <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                </p>
            </div>
        `;

        renderNotesList(stockId);

        sheet.classList.add('sheet-open');
        overlay.classList.replace('opacity-0', 'opacity-100');
        overlay.classList.replace('pointer-events-none', 'pointer-events-auto');
        overlay.onclick = closeStockDetailSheet;
        document.body.style.overflow = 'hidden';
    };

    window.closeStockDetailSheet = () => {
        const sheet = document.getElementById('stock-detail-sheet');
        const overlay = document.getElementById('modal-overlay');

        sheet.classList.remove('sheet-open');
        overlay.classList.replace('opacity-100', 'opacity-0');
        overlay.classList.replace('pointer-events-auto', 'pointer-events-none');
        overlay.onclick = null;
        document.body.style.overflow = '';
        currentStock = null;
    };

    // 9. GTT Fullscreen Window (Side Slide Modal)
    window.openGTTOrder = () => {
        if (!currentStock) return;
        closeStockDetailSheet();

        const gttScreen = document.getElementById('gtt-screen');
        const stock = currentStock;

        const isPositive = stock.percent >= 0;
        const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
        const changeIcon = isPositive ? 'fa-caret-up' : 'fa-caret-down';
        const ltpFormatted = stock.price.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        gttScreen.innerHTML = `
            <!-- GTT Header -->
            <div id="gtt-header" class="p-4 border-b border-gray-100 bg-white sticky top-0">
                <div class="flex items-center justify-between">
                    <!-- Back button now triggers history.back() which is intercepted by popstate -->
                    <i class="fa-solid fa-arrow-left text-lg text-black cursor-pointer" onclick="closeGTTOrder()"></i>
                    <h2 class="text-lg font-bold text-black">Create GTT</h2>
                </div>
                <div class="mt-3 flex justify-between items-end">
                    <div>
                        <p class="text-base font-semibold text-black">${stock.name}</p>
                        <p class="text-xs text-gray-500 uppercase">${stock.index} | LTP: ${ltpFormatted}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm ${changeColor} font-semibold">
                            <i class="fa-solid ${changeIcon} mr-0.5"></i> ${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.percent).toFixed(2)}%)
                        </p>
                    </div>
                </div>
            </div>

            <!-- GTT Form Content -->
            <div id="gtt-form" class="p-4 space-y-5">
                <div class="p-8 text-center bg-gray-50 rounded-lg">
                    <p class="text-gray-600 text-sm">GTT Order interface for ${stock.name} goes here.</p>
                </div>

                <!-- ... Actual Form Elements ... -->

                <!-- Footer Swipe Button -->
                <div class="fixed bottom-0 left-0 w-full max-w-[500px] mx-auto p-4 bg-white border-t border-gray-200">
                    <button id="gtt-swipe-btn" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg text-sm active:bg-blue-700 shadow-lg" onclick="closeGTTOrder()">
                        <i class="fa-solid fa-arrow-right mr-2"></i> SWIPE TO CREATE GTT
                    </button>
                </div>
            </div>
        `;
        document.body.style.overflow = 'hidden';
        isGttOpen = true; // Set flag
        history.pushState({ screen: 'gtt' }, 'GTT', '#gtt'); // Push state for back button

        gttScreen.classList.add('slide-open-side');
    };

    // useHistory = false when called from popstate handler (physical back button)
    window.closeGTTOrder = (useHistory = true) => {
        document.getElementById('gtt-screen').classList.remove('slide-open-side');
        document.body.style.overflow = '';
        currentStock = null;
        isGttOpen = false; // Clear flag

        if (useHistory) {
            history.back(); // This triggers the popstate, which we already handle
        }
    };

    // 10. Add Notes Popup
    const renderNotesList = (stockId) => {
        const notesListEl = document.getElementById('notes-list');
        // Clear previous notes, but keep the header
        notesListEl.querySelectorAll('.stock-note, #no-notes').forEach(el => el.remove());

        const notes = stockNotes[stockId] || [];

        if (notes.length === 0) {
            const noNotesEl = document.createElement('p');
            noNotesEl.id = 'no-notes';
            noNotesEl.className = 'text-xs text-gray-500 italic';
            noNotesEl.textContent = 'No notes added for this stock.';
            notesListEl.appendChild(noNotesEl);
            return;
        }

        notes.reverse().forEach(note => { // Show latest first
            const noteEl = document.createElement('p');
            noteEl.className = 'stock-note text-xs text-black bg-gray-50 p-2 rounded-md border-l-2 border-blue-400';
            const date = new Date(note.created).toLocaleDateString();
            noteEl.innerHTML = `<span class="font-medium">${date}:</span> ${note.content}`;
            notesListEl.appendChild(noteEl);
        });
    };

    window.openAddNotePopup = () => {
        if (!currentStock) return;
        document.getElementById('note-stock-name').textContent = currentStock.name;
        document.getElementById('note-content').value = '';
        const popup = document.getElementById('notes-popup');
        popup.classList.add('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-90', 'scale-100');
    };

    window.closeAddNotePopup = () => {
        const popup = document.getElementById('notes-popup');
        popup.classList.remove('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-100', 'scale-90');
    };

    window.saveNote = async () => {
        if (!userId) return;
        const content = document.getElementById('note-content').value.trim();
        if (!currentStock || !content) return;

        const stockId = currentStock.id;
        const newNote = { content: content, created: Date.now() };

        const newNotesArray = [...(stockNotes[stockId] || []), newNote];
        const updatedNotes = { ...stockNotes, [stockId]: newNotesArray };

        try {
            const notesRef = doc(db, getCollectionPath('notes'), 'my_notes');
            await setDoc(notesRef, { notes: updatedNotes }, { merge: true });

            closeAddNotePopup();
            // Real-time listener will call renderNotesList automatically
        } catch (error) {
            console.error("Error saving note:", error);
        }
    };

    // 11. Set Alert Popup
    window.openSetAlertPopup = () => {
        if (!currentStock) return;
        document.getElementById('alert-current-price').textContent = currentStock.price.toFixed(2);
        document.getElementById('alert-price-input').value = (currentStock.price * 1.01).toFixed(2);

        const popup = document.getElementById('alert-popup');
        popup.classList.add('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-90', 'scale-100');
    };

    window.closeSetAlertPopup = () => {
        const popup = document.getElementById('alert-popup');
        popup.classList.remove('opacity-100', 'pointer-events-auto');
        popup.querySelector('div').classList.replace('scale-100', 'scale-90');
    };

    window.saveAlert = async () => {
        if (!userId) return;
        const price = parseFloat(document.getElementById('alert-price-input').value);
        if (!currentStock || isNaN(price) || price <= 0) return;

        const stockId = currentStock.id;
        const newAlert = {
             price: price,
             created: Date.now(),
             stockName: currentStock.name,
             stockId: stockId
        };

        const newAlertsArray = [...(stockAlerts[stockId] || []), newAlert];
        const updatedAlerts = { ...stockAlerts, [stockId]: newAlertsArray };

        try {
            const alertsRef = doc(db, getCollectionPath('alerts'), 'my_alerts');
            await setDoc(alertsRef, { alerts: updatedAlerts }, { merge: true });

            closeSetAlertPopup();
            // Real-time listener will call checkActiveAlerts automatically
        } catch (error) {
            console.error("Error saving alert:", error);
        }
    };

    // 12. Notification Handling (Alerts)
    window.checkActiveAlerts = () => {
        const alertDot = document.getElementById('alert-dot');
        const alertMessageEl = document.getElementById('alert-message');
        const allAlerts = Object.values(stockAlerts).flat();

        if (allAlerts.length > 0) {
            alertDot.classList.remove('hidden');
            // Simplified: Showing the number of active alerts.
            alertMessageEl.innerHTML = `${allAlerts.length} active alerts.`;
        } else {
            alertDot.classList.add('hidden');
            alertMessageEl.textContent = 'No active alerts.';
        }
    };

    window.openNotificationPopup = () => {
        const popup = document.getElementById('notification-popup');
        popup.classList.toggle('scale-0');
    };

    // 13. Watchlist Swiping Logic (Improved for Visual Feedback)
    const watchlistContainer = document.getElementById('stock-list-container');

    // We rely on the native scroll behavior for smooth transitions now.
    watchlistContainer.addEventListener('scroll', () => {
        // Calculate the current page index
        const scrollPosition = watchlistContainer.scrollLeft;
        const containerWidth = watchlistContainer.offsetWidth;

        // This calculates the index that is currently most visible
        const newIndex = Math.round(scrollPosition / containerWidth);

        if (newIndex !== currentWatchlistIndex) {
            currentWatchlistIndex = newIndex;
            currentWatchlistId = allWatchlists[currentWatchlistIndex]?.id || currentWatchlistId;
            renderWatchlistTabs(); // Update tabs to show correct active state
        }
    });

</script>

    
